suite: controller test
templates:
  - controller/statefulset.yaml
tests:
  - it: can enable static config
    set:
      controller:
        staticConfig:
          configMap: test-map
          configMapKey: "static.yaml"
    asserts:
      - isKind:
          of: StatefulSet
      - isAPIVersion:
          of: apps/v1
      - equal:
          path: metadata.name
          value: default-controller
      - contains:
          path: spec.template.spec.containers[0].command
          content: "--configFile=/var/run/traefikee/config/static.yaml"
  - it: can disable static config
    asserts:
      - isKind:
          of: StatefulSet
      - isAPIVersion:
          of: apps/v1
      - equal:
          path: metadata.name
          value: default-controller
      - notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: staticconfig
            mountPath: /var/run/traefikee/config
          count: 1
      - notContains:
          path: spec.template.spec.containers[0].command
          content: "--configFile=/var/run/traefikee/config/static.yaml"
  - it: should deploy the controller only
    asserts:
      - isKind:
          of: StatefulSet
      - isAPIVersion:
          of: apps/v1
      - equal:
          path: metadata.name
          value: default-controller
      - hasDocuments:
          count: 1
  - it: should override defaults
    set:
      cluster: "mysupertraefikee"
      image.name: "mycustompublisher/myspecialimage"
      image.tag: "myspecialversion"
      image.pullPolicy: Never
      controller:
        count: 2
    asserts:
      - isKind:
          of: StatefulSet
      - isAPIVersion:
          of: apps/v1
      - equal:
          path: metadata.name
          value: mysupertraefikee-controller
      - equal:
          path: spec.template.spec.containers[0].image
          value: "mycustompublisher/myspecialimage:myspecialversion"
      - equal:
          path: spec.replicas
          value: 2
      - equal:
          path: spec.serviceName
          value: mysupertraefikee-ctrl-svc
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Never
      - hasDocuments:
          count: 1

  - it: should add labels and annotations
    set:
      cluster: "mysupertraefikee"
      controller:
        statefulSetLabels:
            st-lb-foo: bar
        statefulSetAnnotations:
            st-an-foo: bar
        podLabels:
            pod-lb-foo: bar
        podAnnotations:
            pod-an-foo: bar
    asserts:
      - isKind:
          of: StatefulSet
      - isAPIVersion:
          of: apps/v1
      - equal:
          path: spec.template.metadata.labels.pod-lb-foo
          value: "bar"
      - equal:
          path: spec.template.metadata.annotations.pod-an-foo
          value: "bar"
      - equal:
          path: metadata.labels.st-lb-foo
          value: "bar"
      - equal:
          path: metadata.annotations.st-an-foo
          value: "bar"

  - it: should have additional arguments
    set:
      controller:
        additionalArguments:
            - --foo=bar
    asserts:
      - isKind:
          of: StatefulSet
      - isAPIVersion:
          of: apps/v1
      - contains:
          path: spec.template.spec.containers[0].command
          content: "--foo=bar"