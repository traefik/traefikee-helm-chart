suite: controller test
templates:
  - stateful-set.yaml
tests:
  - it: can enable static config
    set:
      proxy:
        staticConfig:
          configMap: test-map
          configMapKey: "static.yaml"
    documentIndex: 1
    asserts:
      - isKind:
          of: StatefulSet
      - isAPIVersion:
          of: apps/v1
      - equal:
          path: metadata.name
          value: default-controller
      - contains:
          path: spec.template.spec.containers[0].command
          content: "--configFile=/var/run/traefikee/config/static.yaml"
  - it: can disable static config
    documentIndex: 1
    asserts:
      - isKind:
          of: StatefulSet
      - isAPIVersion:
          of: apps/v1
      - equal:
          path: metadata.name
          value: default-controller
      - notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: staticconfig
            mountPath: /var/run/traefikee/config
          count: 1
      - notContains:
          path: spec.template.spec.containers[0].command
          content: "--configFile=/var/run/traefikee/config/static.yaml"
  - it: should deploy the controller and the plugin registry
    asserts:
      - isKind:
          of: StatefulSet
        documentIndex: 1
      - isKind:
          of: StatefulSet
        documentIndex: 2
      - isAPIVersion:
          of: apps/v1
        documentIndex: 1
      - isAPIVersion:
          of: apps/v1
        documentIndex: 2
      - equal:
          path: metadata.name
          value: default-controller
        documentIndex: 1
      - equal:
          path: metadata.name
          value: default-plugin-registry
        documentIndex: 2
      - hasDocuments:
          count: 3
  - it: should override defaults
    set:
      cluster: "mysupertraefikee"
      proxy.image.name: "mycustompublisher/myspecialimage"
      proxy.image.tag: "myspecialversion"
      proxy.image.pullPolicy: Never
      controllers: 2
    asserts:
      - isKind:
          of: StatefulSet
        documentIndex: 1
      - isAPIVersion:
          of: apps/v1
        documentIndex: 1
      - equal:
          path: metadata.name
          value: mysupertraefikee-controller
        documentIndex: 1
      - equal:
          path: metadata.name
          value: mysupertraefikee-plugin-registry
        documentIndex: 2
      - equal:
          path: spec.template.spec.containers[0].image
          value: "mycustompublisher/myspecialimage:myspecialversion"
        documentIndex: 1
      - equal:
          path: spec.replicas
          value: 2
        documentIndex: 1
      - equal:
          path: spec.serviceName
          value: mysupertraefikee-ctrl-svc
        documentIndex: 1
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Never
        documentIndex: 1
      - hasDocuments:
          count: 3

