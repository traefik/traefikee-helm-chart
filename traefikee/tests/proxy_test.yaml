suite: proxy test
templates:
  - proxy/deployment.yaml
tests:
  - it: should deploy the proxy
    asserts:
      - isKind:
          of: Deployment
      - isAPIVersion:
          of: apps/v1
      - equal:
          path: metadata.name
          value: default-proxy
      - equal:
          path: spec.template.spec.containers[0].image
          value: "traefik/traefikee:v2.9.2"
      - equal:
          path: spec.template.spec.affinity
          value:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                    - matchExpressions:
                      - key: kubernetes.io/os
                        operator: In
                        values:
                          - linux
              podAntiAffinity:
                preferredDuringSchedulingIgnoredDuringExecution:
                  - weight: 100
                    podAffinityTerm:
                      labelSelector:
                        matchExpressions:
                          - key: component
                            operator: In
                            values:
                              - proxies
                      topologyKey: "kubernetes.io/hostname"
  - it: should override defaults
    set:
      cluster: "mysupertraefikee"
      image.name: "mycustompublisher/myspecialimage"
      image.tag: "myspecialversion"
      image.pullPolicy: Never
      proxy:
        replicas: 2
        affinity: null
    asserts:
      - isKind:
          of: Deployment
      - isAPIVersion:
          of: apps/v1
      - equal:
          path: metadata.name
          value: mysupertraefikee-proxy
      - equal:
          path: spec.template.spec.containers[0].image
          value: "mycustompublisher/myspecialimage:myspecialversion"
      - equal:
          path: spec.replicas
          value: 2
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Never
      - hasDocuments:
          count: 1
      - isNull:
          path: spec.template.spec.affinity
  - it: default ports are set
    asserts:
      - isKind:
          of: Deployment
      - isAPIVersion:
          of: apps/v1
      - equal:
          path: metadata.name
          value: default-proxy
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            containerPort: 443
            name: https
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            containerPort: 8484
            name: distributed
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            containerPort: 80
            name: http
  - it: should set imagePullSecrets correctly
    set:
      imagePullSecrets:
        - name: regcred
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: regcred
---
suite: proxy service test
templates:
  - proxy/service.yaml
tests:
  - it: should use LoadBalancer by default
    asserts:
      - isKind:
          of: Service
      - isAPIVersion:
          of: v1
      - equal:
          path: spec.type
          value: LoadBalancer
  - it: should use NodePort
    set:
      proxy:
        serviceType: NodePort
    asserts:
      - isKind:
          of: Service
      - isAPIVersion:
          of: v1
      - equal:
          path: spec.type
          value: NodePort
